### 3.1 任务一：补全四旋翼飞机的动力学模型

在 `MRPC-2025-homework/code/src/uav_simulator/so3_quadrotor_simulator/src/dynamics/Quadrotor.cpp` 中描述了四旋翼的动力学模型，请阅读代码 `Quadrotor.cpp`，补充四旋翼的动力学模型：

```cpp
x_dot = cur_state.v;
//请在这里补充完四旋翼飞机的动力学模型，提示：v_dot应该与重力，总推力，外力和空气阻力相关
// v_dot = //?????

acc_ = v_dot;

R_dot = R * omega_vee;
//请在这里补充完四旋翼飞机的动力学模型，角速度导数的计算涉及到惯性矩阵J_的逆、力矩、科里奥利力（通过角速度与惯性矩阵和角速度的叉积来计算）和外部力矩等因素。
// omega_dot = //??????
```

## 补全思路

### 1. 速度导数（v_dot）的推导

根据牛顿第二定律，四旋翼的加速度由以下力决定：

1. **推力**：四旋翼的推力方向沿机体坐标系的 z 轴（向上），大小为 `thrust`。在世界坐标系中，推力方向由旋转矩阵 `R` 的第三列（`R.col(2)`）给出，因此推力向量为：
   $$
   \mathbf{F}_{thrust} = R \cdot \begin{bmatrix} 0 \\ 0 \\ thrust \end{bmatrix}
   $$

2. **重力**：重力方向沿世界坐标系的 z 轴向下，大小为 $mg$：
   $$
   \mathbf{F}_{gravity} = -mg \begin{bmatrix} 0 \\ 0 \\ 1 \end{bmatrix}
   $$

3. **外部力**：代码中已定义 `external_force_`，直接使用。

4. **空气阻力**：代码中已计算 `resistance`，阻力方向与速度方向相反：
   $$
   \mathbf{F}_{drag} = -resistance \cdot \mathbf{v}_{norm}
   $$
   其中 $\mathbf{v}_{norm}$ 是速度的单位向量。

根据牛顿第二定律：
$$
m \dot{\mathbf{v}} = \mathbf{F}_{thrust} + \mathbf{F}_{gravity} + \mathbf{F}_{external} + \mathbf{F}_{drag}
$$

因此：
$$
\dot{\mathbf{v}} = \frac{1}{m} \left( R \begin{bmatrix} 0 \\ 0 \\ thrust \end{bmatrix} - mg \begin{bmatrix} 0 \\ 0 \\ 1 \end{bmatrix} + \mathbf{F}_{external} - resistance \cdot \mathbf{v}_{norm} \right)
$$

**代码实现**：
```cpp
v_dot = (R * Eigen::Vector3d(0, 0, thrust) - mass_ * g_ * Eigen::Vector3d(0, 0, 1) 
         + external_force_ - resistance * vnorm) / mass_;
```

### 2. 角速度导数（omega_dot）的推导

根据刚体动力学中的欧拉方程，角速度的导数由以下因素决定：

1. **力矩**：代码中已计算 `moments`，包括：
   - Roll 力矩：$M_x = k_f (rpm_3^2 - rpm_4^2) \cdot d$
   - Pitch 力矩：$M_y = k_f (rpm_2^2 - rpm_1^2) \cdot d$
   - Yaw 力矩：$M_z = k_m (rpm_1^2 + rpm_2^2 - rpm_3^2 - rpm_4^2)$

2. **科里奥利力项**：在旋转坐标系中，存在科里奥利力项，表达式为：
   $$
   \boldsymbol{\omega} \times (J \boldsymbol{\omega})
   $$
   这一项表示由于旋转导致的惯性耦合效应。

3. **外部力矩**：代码中已定义 `external_moment_`，直接使用。

欧拉方程：
$$
J \dot{\boldsymbol{\omega}} = \mathbf{M} - \boldsymbol{\omega} \times (J \boldsymbol{\omega}) + \mathbf{M}_{external}
$$

因此：
$$
\dot{\boldsymbol{\omega}} = J^{-1} \left( \mathbf{M} - \boldsymbol{\omega} \times (J \boldsymbol{\omega}) + \mathbf{M}_{external} \right)
$$

**代码实现**：
```cpp
omega_dot = J_.inverse() * (moments - cur_state.omega.cross(J_ * cur_state.omega) 
                            + external_moment_);
```

### 3. 物理意义说明

- **速度导数**：描述了四旋翼在平移运动中的加速度，由推力、重力、外力和空气阻力的合力决定。推力需要从机体坐标系转换到世界坐标系。

- **角速度导数**：描述了四旋翼在旋转运动中的角加速度，由力矩、科里奥利力项和外部力矩决定。科里奥利力项体现了旋转坐标系中的惯性耦合效应。

**补全完成之后进行测试：**

#### 步骤 1：编译代码

首先要对文件进行**编译**。**注意：每次修改完代码之后，都要重新编译，所修改的内容才会生效。**

```bash
cd MRPC-2025-homework
catkin_make
```

如果最后编译到 `100%` 并且没有显示报错，则说明编译成功。

#### 步骤 2：测试无人机悬停

测试一下无人机的悬停，确认代码补全正确：

```bash
cd MRPC-2025-homework
source devel/setup.bash
roslaunch trajectory_generator test_control.launch
```

会弹出可视化界面：

<img src="../assets/image-20251113202022886.png" width="500">

#### 步骤 3：验证悬停效果

目前无人机已经停在空中约 3 米的位置上，在 Rviz 中如下图所示：

<img src="../assets/image-20251113202128649.png" width="400">

#### 步骤 4：测试移动

点击 Rviz 中的 `3D Nav Goal`，在界面中的白色地板上进行拖动。倘若无人机能够沿着 z 轴向上移动 6m，则表明你的修改成功。倘若飞机不能向上移动则表明修改失败。

<img src="../assets/image-20251113202237918.png" width="400">

**提交方式**：请在报告中稍微介绍一下任务一的补全思路，注意简洁清晰，切勿放大段代码。

### 3.3 任务三：控制器参数调试

## 1. 控制器原理分析

### 1.1 SO3 控制器结构

SO3 控制器是一个位置-速度（PD）控制器，控制力计算公式为：

```cpp
force_ = kx * (des_pos - pos_) + kv * (des_vel - vel_) 
       + mass * des_acc + mass * ka * (des_acc - acc_)
       + mass * g * [0, 0, 1]
```

其中：
- **kx**：位置误差增益（比例项），控制位置跟踪的响应速度
- **kv**：速度误差增益（微分项），控制速度跟踪和阻尼
- **des_pos - pos_**：位置误差
- **des_vel - vel_**：速度误差
- **des_acc**：期望加速度（前馈项）
- **ka**：加速度误差增益（自适应项）
- **mass * g * [0, 0, 1]**：重力补偿项

### 1.2 参数作用分析

**kx 参数（位置增益）：**
- `kx(0)`：X 轴位置误差增益
- `kx(1)`：Y 轴位置误差增益
- `kx(2)`：Z 轴位置误差增益
- **增大 kx**：提高位置跟踪精度，但可能导致超调和振荡
- **减小 kx**：降低响应速度，但系统更稳定

**kv 参数（速度增益）：**
- `kv(0)`：X 轴速度误差增益
- `kv(1)`：Y 轴速度误差增益
- `kv(2)`：Z 轴速度误差增益
- **增大 kv**：增强阻尼，减少振荡，但可能降低响应速度
- **减小 kv**：提高响应速度，但可能导致超调和振荡

---

## 2. 调参思路

### 2.1 初始参数分析

当前默认参数：
```cpp
kx_ = Eigen::Vector3d(15.7, 8.7, 6.0);   // [x, y, z]
kv_ = Eigen::Vector3d(6.4, 13.4, 4.0);   // [x, y, z]
```

**观察：**
- X 轴：kx 较大（15.7），kv 较小（6.4）→ 可能响应快但易振荡
- Y 轴：kx 中等（8.7），kv 较大（13.4）→ 阻尼较强，可能较稳定
- Z 轴：kx 较小（6.0），kv 较小（4.0）→ 响应较慢，可能跟踪精度不足

### 2.2 调参策略

#### 策略 1：平衡响应速度和稳定性

**原则：**
- kx 和 kv 需要平衡，避免过大或过小
- 通常 kx/kv 的比值在 2-3 之间较为合理
- Z 轴（高度）需要更谨慎，因为重力影响较大

**建议参数范围：**
- kx: [8.0, 20.0] 各轴
- kv: [5.0, 15.0] 各轴
- kx/kv 比值：约 1.5 - 3.0

#### 策略 2：分轴调参

**X/Y 轴（水平方向）：**
- 可以设置相同的参数，因为水平方向对称
- 如果轨迹跟踪有偏差，可以适当增大 kx
- 如果出现振荡，增大 kv 或减小 kx

**Z 轴（高度方向）：**
- 需要更保守的参数，因为重力补偿的影响
- 通常 kx 和 kv 都设置得比水平方向小一些
- 如果高度跟踪不稳定，优先调整 kv

#### 策略 3：迭代调参流程

1. **初始测试**：使用默认参数运行，观察轨迹跟踪效果
2. **识别问题**：
   - 如果跟踪误差大 → 增大 kx
   - 如果出现振荡 → 增大 kv 或减小 kx
   - 如果响应慢 → 增大 kx 和 kv
3. **逐步调整**：每次只调整一个轴的参数，观察效果
4. **评估指标**：
   - RMSE（均方根误差）：越小越好
   - 轨迹运行时间：适中即可
   - 碰撞次数：应该为 0
   - 综合评价得分：越低越好

---

## 3. 实现代码

### 3.1 参数调整位置

在 `so3_control_nodelet.cpp` 的 `position_cmd_callback` 函数中：

```cpp
void SO3ControlNodelet::position_cmd_callback(
  const quadrotor_msgs::PositionCommand::ConstPtr& cmd)
{
  des_pos_ = Eigen::Vector3d(cmd->position.x, cmd->position.y, cmd->position.z);
  des_vel_ = Eigen::Vector3d(cmd->velocity.x, cmd->velocity.y, cmd->velocity.z);
  des_acc_ = Eigen::Vector3d(cmd->acceleration.x, cmd->acceleration.y,
                             cmd->acceleration.z);

  // 调整参数：根据测试结果优化
  kx_ = Eigen::Vector3d(15.7, 8.7, 6.0);   // [x, y, z] 位置增益
  kv_ = Eigen::Vector3d(6.4, 13.4, 4.0);   // [x, y, z] 速度增益

  des_yaw_              = cmd->yaw;
  des_yaw_dot_          = cmd->yaw_dot;
  position_cmd_updated_ = true;
  position_cmd_init_    = true;

  publishSO3Command();
}
```

### 3.2 调参示例

**示例 1：提高跟踪精度（增大 kx）**
```cpp
kx_ = Eigen::Vector3d(18.0, 10.0, 7.0);   // 各轴都增大
kv_ = Eigen::Vector3d(6.4, 13.4, 4.0);    // 保持不变
```

**示例 2：减少振荡（增大 kv）**
```cpp
kx_ = Eigen::Vector3d(15.7, 8.7, 6.0);    // 保持不变
kv_ = Eigen::Vector3d(8.0, 15.0, 5.0);    // 各轴都增大
```

**示例 3：平衡调参**
```cpp
kx_ = Eigen::Vector3d(16.0, 9.0, 6.5);    // 适度增大
kv_ = Eigen::Vector3d(7.0, 14.0, 4.5);    // 适度增大
```

---

## 4. 测试和评估

### 4.1 运行测试脚本

```bash
cd MRPC-2025-homework/
python3 calculate_results.py
```

### 4.2 评估指标

**输出示例：**
```
计算得到的均方根误差(RMSE)值为: 0.11586971639650995
轨迹运行总时间为: 47.12802791595459
总轨迹长度为: 33.97356465040666
是否发生了碰撞: 1
综合评价得分为(综合分数越低越好): 1.3102676466588432
```

**指标分析：**
- **RMSE**：应该 < 0.2，越小越好
- **轨迹运行时间**：适中即可，不要过快或过慢
- **碰撞次数**：必须为 0
- **综合评价得分**：综合考虑所有因素，越低越好

### 4.3 调参记录表

| 参数组合 | kx [x,y,z] | kv [x,y,z] | RMSE | 运行时间 | 碰撞 | 综合得分 | 备注 |
|---------|-----------|-----------|------|---------|------|---------|------|
| 默认参数 | [15.7, 8.7, 6.0] | [6.4, 13.4, 4.0] | - | - | - | - | 初始测试 |
| 组合1 | - | - | - | - | - | - | - |
| 组合2 | - | - | - | - | - | - | - |

---

## 5. 调参技巧总结

### 5.1 常见问题及解决方案

**问题 1：轨迹跟踪误差大**
- **原因**：kx 过小，位置响应不足
- **解决**：逐步增大 kx，每次增加 10-20%

**问题 2：系统振荡**
- **原因**：kx 过大或 kv 过小，阻尼不足
- **解决**：减小 kx 或增大 kv，增加阻尼

**问题 3：响应速度慢**
- **原因**：kx 和 kv 都过小
- **解决**：同时增大 kx 和 kv，保持比例

**问题 4：高度不稳定**
- **原因**：Z 轴参数不当，重力补偿影响
- **解决**：优先调整 kv_z，增加阻尼

### 5.2 最佳实践

1. **从默认参数开始**：先测试默认参数，了解系统特性
2. **单轴调整**：每次只调整一个轴的参数，便于观察效果
3. **小步调整**：每次调整幅度不要超过 20-30%
4. **多次测试**：每个参数组合至少测试 3-5 次，取平均值
5. **记录结果**：建立调参记录表，便于对比分析
6. **综合考虑**：不仅要看 RMSE，还要考虑稳定性、碰撞等因素

### 5.3 参数范围建议

**保守参数（稳定优先）：**
```cpp
kx_ = Eigen::Vector3d(12.0, 7.0, 5.0);
kv_ = Eigen::Vector3d(8.0, 12.0, 5.0);
```

**激进参数（精度优先）：**
```cpp
kx_ = Eigen::Vector3d(20.0, 12.0, 8.0);
kv_ = Eigen::Vector3d(5.0, 10.0, 3.0);
```

**平衡参数（推荐）：**
```cpp
kx_ = Eigen::Vector3d(16.0, 9.0, 6.5);
kv_ = Eigen::Vector3d(7.0, 14.0, 4.5);
```

---

## 6. 提交要求

1. **代码修改**：在 `so3_control_nodelet.cpp` 中调整参数
2. **测试结果**：运行 `calculate_results.py` 生成 `solutions/result.txt`
3. **视频录制**：录制飞行视频，保存为 `solutions/video.mp4`
4. **报告内容**：
   - 最终使用的参数值
   - 调参思路和过程
   - 测试结果（RMSE、运行时间等）
   - 结果分析和优化建议


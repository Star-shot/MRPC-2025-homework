### 1\. 动力学建模简化对控制分配的影响

四旋翼的经典刚体动力学模型通常写作：

  * **平动**：$m \ddot{p} = -m g \mathbf{e}_3 + R \mathbf{f}_T + \mathbf{f}_{ext}$
  * **转动**：$J \dot{\omega} = -\omega \times J \omega + \tau$

其中 $m$ 是质量，$J$ 是转动惯量，$\mathbf{f}_T$ 是机体轴向推力，$\mathbf{f}_{ext}$ 是外部力（如空气阻力）。

**建模简化对控制分配（Control Allocation）的影响：**

  * **质量 ($m$) 的简化**：
      * 控制分配通常假设四个电机产生的合力直接线性对应加速度。
      * **影响**：质量是位置控制环（外环）到姿态/推力分配的核心比例因子。如果模型中忽略了载荷变化或电池消耗导致的质量变化，控制器计算出的\*\*所需推力（Thrust）\*\*就会直接出现偏差。
  * **惯量 ($J$) 的简化**：
      * 通常假设惯量矩阵是常数且对角化（忽略非对角元素的耦合）。
      * **影响**：惯量矩阵将姿态控制器的**力矩指令（Torque）映射为电机的转速差。如果惯量估计过小，控制器会认为机体很轻灵，输出较小的力矩，导致实际姿态响应迟钝（Sluggish）**；反之，若惯量估计过大，输出力矩过大，会导致姿态\*\*震荡（Oscillation）\*\*甚至失稳。
  * **气动阻尼 ($F_d$) 的简化**：
      * 大多数基础模型（包括代码中的）通常忽略空气阻力（即假设 $F_d = 0$）。
      * **影响**：在高速飞行时，空气阻力显著。忽略它意味着控制器认为施加了力就会一直加速，而实际上速度会趋于饱和。这导致控制分配在高速段的**前馈失效**，完全依赖反馈项去“硬抗”风阻，增加了跟踪误差。

-----

### 2\. 质量与阻尼估计错误的预期观测现象

如果模型参数与物理实物不一致，在轨迹跟踪中会出现典型的问题：

#### **A. 质量估计有误 ($m_{model} \neq m_{real}$)**

  * **现象：Z 轴稳态偏差（Steady-state Error in Height）**
      * **$m_{model} < m_{real}$（估计偏小）**：控制器计算的重力补偿项 $F_{ff} = m_{model} g$ 不足以抵消真实重力。无人机必须下掉一段距离，依靠位置反馈项 $K_p (z_{des} - z_{actual})$ 来补足剩下的升力。**结果：无人机悬停位置低于目标位置（掉高）。**
      * **$m_{model} > m_{real}$（估计偏大）**：重力补偿过剩。**结果：无人机悬停位置高于目标位置。**
      * *注：如果有积分项（Integral term），这个偏差最终会被消除，但初期响应会受影响。*

#### **B. 阻尼估计有误（通常指忽略阻尼）**

  * **现象 1：动态跟踪滞后（Tracking Lag / Following Error）**
      * 在飞直线匀速轨迹时，真实空气阻力 $F_d = -k_v v$ 会拖后腿。由于控制器没有前馈抵消这个力，必须依靠位置误差 $e_p$ 产生反馈力来平衡阻力。**结果：无人机始终落在参考轨迹后面一段距离。**
  * **现象 2：过冲（Overshoot）**
      * 当无人机需要减速停车时，控制器认为撤去推力惯性就会保持（$F=ma$），但实际上阻力会辅助刹车。如果控制器没有考虑到阻力辅助，可能会导致刹车过猛或在低速微调时出现过冲振荡。

-----

### 3\. 加入气动阻力 $F_d = -k_v v$ 的调整策略

若要引入线性阻尼模型来优化性能，可以选择在**控制层**或**规划层**进行调整。

#### **在控制层（SO3Control）调整**

**做法**：修改 `calculateControl` 函数，在计算 `force_` 时显式加入阻力补偿项（即前馈控制）。
由于 $F_{drag} \approx -k_v v$，我们需要产生一个反向力来抵消它。

**代码思路**：

```cpp
// 在计算 force_ 时加入一项 + kv_drag * des_vel 或 + kv_drag * vel_
force_.noalias() = ... + mass_ * g_ * e3 
                   + drag_gain.asDiagonal() * des_vel; // 气动阻力补偿
```

  * **优点**：
      * **动态响应好**：直接在底层抵消了物理阻力，使得外环闭环系统更接近理想的积分器模型。
      * **精度高**：能显著减小高速巡航时的跟踪误差。
  * **缺点**：
      * **依赖速度估计**：如果状态估计器（Observer/VIO）的速度噪声大，这一项会直接把噪声引入电机控制，导致机身震动。
      * **参数辨识难**：$k_v$ 通常随风场和机身姿态变化，难以精确标定。

#### **在规划层（轨迹限速）调整**

**做法**：在 A\* 或 Minimum Snap 轨迹生成阶段，限制最大速度 $v_{max}$ 和最大加速度 $a_{max}$。

  * **优点**：
      * **安全性高**：通过限制速度，确保气动阻力始终处于较小、可被反馈控制器鲁棒性覆盖的范围内。
      * **实现简单**：不需要改动底层控制器代码，不用担心噪声放大。
  * **缺点**：
      * **性能牺牲**：为了迁就模型误差，人为限制了无人机的机动性能，无法发挥其最大飞行速度。
      * **治标不治本**：跟踪误差依然存在，只是幅度变小了。

-----

### 4\. 调整参数的思路

选择在控制层进行调整，思路如下：

1.  **准备阶段**：确保姿态环和基础的位置环（$K_p, K_d$）已经调好，悬停稳定。
2.  **前馈辨识实验（Constant Velocity Test）**：
      * 让无人机以恒定速度 $V_{test}$ 沿 x 轴飞行。
      * 记录此时位置控制器的输出倾角 $\theta$。
      * 在匀速飞行中，推力的水平分量平衡了阻力：$mg \tan\theta \approx k_v V_{test}$。
      * 由此估算出 $k_v \approx \frac{mg \tan\theta}{V_{test}}$。
3.  **在线微调**：
      * 将估算的 $k_v$ 加入控制器前馈。
      * 再次进行高速往返飞行，观察跟踪误差（尤其是滞后误差）。
      * 如果依然**滞后**（落在目标后面），说明补偿不足，**增大 $k_v$**。
      * 如果出现**超前**或停车时**震荡**，说明补偿过度，**减小 $k_v$**。